# Feature Specification: 状態の自動保存

**Feature Branch**: `009-auto-save-state`
**Created**: 2025-12-09
**Status**: Draft
**Input**: User description: "閉じて開いたとき、閉じたときの盤面、持ち駒、手番が保持されていてほしい。ボタンなどは不要にして自動で保存されること。"

<!-- 注意: このテンプレートから生成される仕様書は、憲法に従い日本語で記述してください -->

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ゲーム再開時の状態復元 (Priority: P1)

ユーザーが将棋アプリを使用中にブラウザを閉じ、後で再び開いたときに、閉じる前の盤面、持ち駒、手番がそのまま復元されている。ユーザーは中断した局面から続けて対局や観賞ができる。

**Why this priority**: これは機能の核心的価値であり、ユーザーが期待する基本的な体験である。状態が保存されないと、ユーザーは作業を失い、フラストレーションを感じる。

**Independent Test**: ブラウザを開いて駒を動かし、ブラウザを閉じて再度開く。閉じる前と同じ盤面、持ち駒、手番が表示されれば成功。

**Acceptance Scenarios**:

1. **Given** ユーザーが新規セッションでアプリを開いている、**When** 駒を数手動かして盤面を変更する、**Then** 盤面の状態が変更される
2. **Given** 盤面が特定の状態にある、**When** ブラウザタブを閉じて再度開く、**Then** 閉じる前と同じ盤面、持ち駒、手番が表示される
3. **Given** 複数の駒を動かし、持ち駒が存在する状態、**When** ブラウザを完全に終了して再起動し、アプリを開く、**Then** 終了前の盤面、持ち駒、手番が正確に復元される

---

### User Story 2 - 自動保存の透明性 (Priority: P2)

ユーザーは保存操作を意識することなく、盤面の状態が自動的に保存される。保存ボタンや保存確認は不要で、駒を動かすたびにシームレスに状態が保存される。

**Why this priority**: ユーザー体験の向上に直結する。手動保存の煩わしさを排除し、ユーザーが対局や観賞に集中できる環境を提供する。

**Independent Test**: 駒を動かした直後にブラウザの開発者ツールで保存された状態を確認できる。また、駒を動かしてすぐにブラウザを閉じても状態が保持されていれば成功。

**Acceptance Scenarios**:

1. **Given** ユーザーが盤面上で駒を動かす、**When** 駒の移動が完了する、**Then** その状態が即座に自動保存される（ユーザーには見えない）
2. **Given** 持ち駒を盤面に配置する、**When** 配置が完了する、**Then** 新しい盤面状態が自動保存される
3. **Given** 手番が切り替わる、**When** 切り替え完了、**Then** 手番情報も含めて自動保存される

---

### User Story 3 - 履歴ナビゲーション後の状態保存 (Priority: P2)

ユーザーが手順履歴をナビゲートして過去の局面に戻り、そこからブラウザを閉じた場合、再度開いたときにはその過去の局面が復元される。

**Why this priority**: 既存の履歴ナビゲーション機能（008-move-history-navigation）との統合が重要。ユーザーが任意の時点の局面を保存・復元できることで、より柔軟な使用体験を提供する。

**Independent Test**: 複数手進めた後、履歴ナビゲーションで3手前に戻り、ブラウザを閉じて再度開く。3手前の局面が表示されれば成功。

**Acceptance Scenarios**:

1. **Given** ユーザーが10手進んだ局面にいる、**When** 履歴ナビゲーションで5手前に戻る、**Then** 5手前の盤面、持ち駒、手番が表示される
2. **Given** 履歴ナビゲーションで過去の局面を表示している、**When** ブラウザを閉じて再度開く、**Then** ナビゲートした過去の局面が復元される
3. **Given** 履歴ナビゲーションで過去の局面に戻っている、**When** ブラウザを閉じて再度開き、ナビゲーションボタンで手を進める、**Then** 保存された履歴に従って次の局面が正しく表示される
4. **Given** 履歴の途中の局面を表示している、**When** そこから新しい手を指す、**Then** 新しい分岐が作成され、その状態が保存される

---

### Edge Cases

- 初回訪問時（保存された状態がない場合）はどうなるか？→ 初期配置が表示される
- 保存された状態データが破損している場合はどうなるか？→ 初期配置にフォールバックする
- 複数のブラウザタブで同時に開いた場合、状態の同期はどうなるか？→ 各タブが独立して動作し、最後に閉じたタブの状態が保存される
- ブラウザのストレージが満杯の場合はどうなるか？→ 保存に失敗するが、現在のセッション中は動作を続ける
- ページをリロードした場合はどうなるか？→ 閉じて開いたときと同様に、リロード前の状態が復元される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは駒が動かされるたびに、現在の盤面状態（全ての駒の位置）を自動的に保存しなければならない
- **FR-002**: システムは持ち駒の状態（先手・後手それぞれの持ち駒リスト）を自動的に保存しなければならない
- **FR-003**: システムは現在の手番（先手または後手）を自動的に保存しなければならない
- **FR-004**: システムは履歴情報（過去の手順の配列と現在の履歴インデックス）を自動的に保存しなければならない
- **FR-005**: システムはページ読み込み時に、保存された状態が存在する場合はそれを読み込んで盤面を復元しなければならない
- **FR-006**: システムは保存された状態が存在しない場合、または読み込みに失敗した場合、初期配置を表示しなければならない
- **FR-007**: システムはユーザーが保存や読み込みを手動で操作する必要がないように、全ての保存・復元処理を自動的に実行しなければならない
- **FR-008**: システムは状態の保存失敗時にも、現在のセッション中は正常に動作を継続しなければならない
- **FR-009**: システムは履歴ナビゲーションによる状態変更も自動保存の対象としなければならない

### Key Entities

- **ゲーム状態**: 盤面上の全ての駒の位置情報、各駒の種類と所属（先手/後手）、成り状態を含む
- **持ち駒情報**: 先手と後手それぞれが保持する捕獲した駒のリスト
- **手番情報**: 現在どちらのプレイヤー（先手または後手）の番であるかを示す
- **履歴情報**: 過去の手順の配列と、現在表示している履歴上の位置（インデックス）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーはブラウザを閉じて再度開いたとき、100%の確率で閉じる前の盤面、持ち駒、手番が復元される
- **SC-002**: 状態の自動保存はユーザーのアクション完了から100ミリ秒以内に完了する（ユーザーが待たされることがない）
- **SC-003**: ユーザーは保存に関する操作（ボタンクリック、確認ダイアログなど）を一切行う必要がない
- **SC-004**: 初回訪問時や保存データが破損している場合でも、システムは正常に初期配置を表示してエラーを起こさない
- **SC-005**: 履歴ナビゲーションで任意の過去の局面に移動した後、ブラウザを閉じて再度開いても、その過去の局面が正確に復元される
