# Research: ターンベース駒移動制御

**Feature**: 004-turn-based-movement | **Date**: 2025-11-02

## 調査項目

### 1. ターン状態管理のベストプラクティス

**Decision**: React Hooks (useState) を使用した単純な状態管理

**Rationale**:
- 既存のコードベース(003-piece-movement)でReact Hooksを使用しており、一貫性が保たれる
- ターン状態は単純な列挙型('sente' | 'gote')であり、複雑な状態管理ライブラリ(Redux、Zustand等)は不要
- useState でゲーム状態オブジェクト内にターン情報を含めることで、状態の一貫性が保証される
- パフォーマンス要件(0.5秒以内のターン切り替え)は単純な状態更新で十分達成可能

**Alternatives considered**:
- **Redux/Zustand等の状態管理ライブラリ**: 過剰な複雑性を導入し、YAGNI原則に反する。現時点でグローバル状態管理の必要性なし
- **Context API**: 現状では単一コンポーネント階層内で状態を管理可能。将来的に複数のコンポーネントツリーで共有が必要になった場合に検討
- **useReducer**: ターン切り替えのロジックは単純('sente' ↔ 'gote')であり、reducerパターンの恩恵が少ない

### 2. 視覚的フィードバックの実装方法

**Decision**: Tailwind CSS のユーティリティクラスとCSS アニメーションを組み合わせて実装

**Rationale**:
- 既存のプロジェクトでTailwind CSS 4.1.16を使用しており、一貫性が保たれる
- カーソル変化: `cursor-not-allowed` クラスで簡単に実装可能
- 選択不可表示: `opacity-50` や `pointer-events-none` で視覚的に示せる
- アニメーション効果: Tailwind の `animate-` クラスまたはカスタムCSS keyframesで実装
- パフォーマンス: CSS アニメーションはGPUアクセラレーションが効き、100ms以内の応答要件を満たせる

**Alternatives considered**:
- **Framer Motion等のアニメーションライブラリ**: 高度なアニメーションには有用だが、本フェーチャーでは単純な揺れ/点滅で十分。依存関係を増やす必要なし
- **JavaScript ベースのアニメーション**: CSSアニメーションより複雑で、パフォーマンスも劣る可能性あり
- **SVG アニメーション**: 本フェーチャーでは不要。HTMLとCSSで十分

### 3. ターン検証のタイミング

**Decision**: 駒選択時(onClick ハンドラー内)にターン検証を実行

**Rationale**:
- ユーザーが駒をクリックした瞬間に検証することで、即座のフィードバックが可能
- 既存の `handleSquareClick` ロジック内に統合でき、コードの変更範囲を最小化
- 移動可能なマスのハイライト表示前に検証することで、無効な操作を早期に防ぐ
- パフォーマンス: 同期処理で十分(検証ロジックは単純な比較演算のみ)

**Alternatives considered**:
- **移動実行時に検証**: フィードバックが遅れ、ユーザー体験が低下。移動可能マスのハイライトまで表示されてしまう
- **ホバー時に検証**: 過剰なフィードバックでユーザーが混乱する可能性。クリック時のみで十分
- **移動ルール判定と統合**: 責任の分離が不明確になる。ターン検証と移動ルール検証は別の関心事

### 4. ターン表示コンポーネントの配置と実装

**Decision**: 独立した `TurnDisplay` コンポーネントを作成し、盤面上部中央に配置

**Rationale**:
- 単一責任の原則: ターン表示のロジックとUIを一箇所に集約
- 再利用性: 将来的に他の場所にも配置可能
- テストの容易性: 独立したコンポーネントとして単体テスト可能
- 視認性: 盤面上部中央は両プレイヤーから最も見やすい位置
- 明確化セッションでの決定事項に準拠

**Alternatives considered**:
- **ShogiBoard コンポーネント内に直接実装**: コンポーネントの責任が肥大化し、テストが複雑になる
- **Board コンポーネントに統合**: ターン表示は盤面の外側にあるべきで、Board内に含めるのは意味的に不適切
- **サイドバーに配置**: 視認性が低下し、明確化セッションでの決定に反する

### 5. アニメーション効果の実装詳細

**Decision**: CSS keyframes でカスタムアニメーション(`shake`, `pulse`)を定義し、Tailwind の `animate-` クラスで適用

**Rationale**:
- 軽い揺れ: `@keyframes shake` で translateX を使用した左右の揺れ(5度程度)
- 点滅: `@keyframes pulse` で opacity を変化させる
- アニメーション期間: 0.5秒程度(ユーザーの注意を引きつつ、過度に邪魔にならない)
- トリガー: 無効操作時に条件付きでクラスを追加/削除
- アクセシビリティ: `prefers-reduced-motion` メディアクエリで、アニメーションを無効化するオプションを提供

**Alternatives considered**:
- **より派手なアニメーション**: ユーザー体験を損なう可能性。明確化セッションで「軽い」揺れと決定済み
- **アニメーションなし**: 明確化セッションでの決定に反する
- **JavaScript ベースのアニメーション**: CSSより複雑で、パフォーマンスが劣る

## 技術的決定事項まとめ

| 項目 | 決定内容 | 主な理由 |
|------|----------|----------|
| 状態管理 | React Hooks (useState) | シンプルさ、既存コードとの一貫性 |
| 視覚的フィードバック | Tailwind CSS + CSS アニメーション | 既存技術スタック、パフォーマンス |
| ターン検証タイミング | 駒選択時(onClick) | 即座のフィードバック、早期エラー検出 |
| ターン表示配置 | 独立コンポーネント、盤面上部中央 | 単一責任、視認性、テストの容易性 |
| アニメーション実装 | CSS keyframes (shake, pulse) | シンプルさ、パフォーマンス、アクセシビリティ |

## 未解決の懸念事項

なし - 全ての技術的決定事項が明確化された
