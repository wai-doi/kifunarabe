# Feature Specification: ターンベース駒移動制御

**Feature Branch**: `004-turn-based-movement`
**Created**: 2025-11-02
**Status**: Draft
**Input**: User description: "駒を先手と後手交互にしか動かせないこと。先手の番では先手の駒を、後手の番では後手の駒しか動かせないこと"

## Clarifications

### Session 2025-11-02

- Q: 無効な操作（相手のターンに駒を選択しようとする）を行った際のユーザーフィードバックはどうしますか？ → A: 視覚的フィードバックのみ（駒が選択できない、カーソル変化、バウンスアニメーション等）
- Q: ページをリロードした際、現在のターン状態とゲーム盤面をどう扱いますか？ → A: 初期状態にリセット（先手のターン、初期配置に戻る）
- Q: ターン表示の強調表示（無効操作時）は具体的にどのような動作ですか？ → A: アニメーション効果（軽い揺れや点滅）
- Q: ターン切り替えやエラー操作のログ記録は必要ですか？ → A: 不要（ログ記録なし）
- Q: ターン表示の配置場所はどこが適切ですか？ → A: 盤面の上部中央

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 先手の駒を先手の番に動かす (Priority: P1)

先手のプレイヤーは、自分のターンにのみ自分の駒を動かすことができる。後手の駒を動かそうとした場合、または後手のターンに駒を動かそうとした場合は、操作が拒否される。

**Why this priority**: 将棋の基本ルールであり、ゲームの公平性と正しい進行に不可欠。この機能がなければ、将棋として成立しない。

**Independent Test**: 先手のターンで先手の駒を選択して有効な移動先をクリックすると駒が移動し、ターンが後手に切り替わることを確認できる。また、先手のターンで後手の駒を選択しても何も起こらないことを確認できる。

**Acceptance Scenarios**:

1. **Given** ゲームが開始され、先手のターンである、**When** ユーザーが先手の駒を選択して有効な移動先をクリックする、**Then** 駒が移動し、ターンが後手に切り替わる
2. **Given** 先手のターンである、**When** ユーザーが後手の駒を選択しようとする、**Then** 駒は選択されず、視覚的フィードバック（カーソル変化、選択不可表示等）が提供される
3. **Given** 先手のターンである、**When** ユーザーが先手の駒を選択する、**Then** その駒の有効な移動先のみがハイライト表示される

---

### User Story 2 - 後手の駒を後手の番に動かす (Priority: P1)

後手のプレイヤーは、自分のターンにのみ自分の駒を動かすことができる。先手の駒を動かそうとした場合、または先手のターンに駒を動かそうとした場合は、操作が拒否される。

**Why this priority**: User Story 1と同じ理由で、将棋の基本ルールの実装に必須。両プレイヤーに対して公平なルールを提供する。

**Independent Test**: 後手のターンで後手の駒を選択して有効な移動先をクリックすると駒が移動し、ターンが先手に切り替わることを確認できる。また、後手のターンで先手の駒を選択しても何も起こらないことを確認できる。

**Acceptance Scenarios**:

1. **Given** 後手のターンである、**When** ユーザーが後手の駒を選択して有効な移動先をクリックする、**Then** 駒が移動し、ターンが先手に切り替わる
2. **Given** 後手のターンである、**When** ユーザーが先手の駒を選択しようとする、**Then** 駒は選択されず、視覚的フィードバック（カーソル変化、選択不可表示等）が提供される
3. **Given** 後手のターンである、**When** ユーザーが後手の駒を選択する、**Then** その駒の有効な移動先のみがハイライト表示される

---

### User Story 3 - ターン表示と確認 (Priority: P2)

ユーザーは、現在どちらのターンであるかを常に視覚的に確認できる。ターンが切り替わるたびに、表示が更新される。

**Why this priority**: ユーザビリティの向上に重要だが、P1のコア機能が動作すれば基本的なゲームは成立する。しかし、ユーザー体験を大きく向上させる。

**Independent Test**: ゲーム開始時に「先手の番」と表示され、先手が駒を動かした後に「後手の番」と表示が切り替わることを確認できる。

**Acceptance Scenarios**:

1. **Given** ゲームが開始された、**When** 画面を見る、**Then** 盤面の上部中央に「先手の番」または「後手のターン」が明確に表示されている
2. **Given** 駒が移動してターンが切り替わった、**When** 移動が完了する、**Then** ターン表示が即座に更新される
3. **Given** ターン表示が表示されている、**When** ユーザーが現在のターンではない駒を選択しようとする、**Then** 操作が拒否され、ターン表示がアニメーション効果（軽い揺れや点滅）で強調される

---

### Edge Cases

- ゲーム開始時は常に先手のターンから始まる
- 駒を選択中にターンが切り替わった場合（何らかのエラーやシステムリセットが発生した場合）、選択状態はクリアされる
- 無効な操作（相手のターンに自分の駒を動かそうとする）を連続して試みた場合、システムは各試行に対して一貫して操作を拒否する
- ページをリロードした場合、ゲーム状態は初期状態にリセットされる（先手のターン、初期配置）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは常に現在のターン（先手または後手）を管理しなければならない
- **FR-002**: システムはゲーム開始時およびページリロード時に先手のターンとして初期化されなければならない
- **FR-003**: ユーザーが駒を選択しようとした際、システムは選択された駒の所有者（先手または後手）と現在のターンが一致するかを検証しなければならない
- **FR-004**: 現在のターンと一致しない駒が選択された場合、システムは選択を拒否し、視覚的フィードバック（カーソル変化、選択不可表示等）を提供しなければならない
- **FR-005**: 駒が正常に移動した際、システムは自動的に次のプレイヤーにターンを切り替えなければならない
- **FR-006**: システムは駒を選択する前に、その駒が現在のターンのプレイヤーに属するかをチェックしなければならない
- **FR-007**: システムは現在のターン情報を盤面の上部中央に視覚的に表示しなければならない
- **FR-009**: 無効な操作が試みられた際、システムはターン表示をアニメーション効果（軽い揺れや点滅）で一時的に強調しなければならない
- **FR-008**: ターンが切り替わった際、システムは以前に選択されていた駒の選択状態をクリアしなければならない

### Key Entities

- **Turn**: 現在のターン状態を表す。先手（SENTE）または後手（GOTE）の値を持つ
- **Piece**: 駒を表す。所有者（先手または後手）の情報を持つ
- **GameState**: ゲーム全体の状態を管理。現在のターン、盤面の状態、選択中の駒などを含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは自分のターンにのみ自分の駒を動かすことができ、相手のターンまたは相手の駒を動かそうとした場合、100%の確率で操作が拒否される
- **SC-002**: 駒が正常に移動した後、0.5秒以内にターンが切り替わり、次のプレイヤーが操作可能になる
- **SC-003**: 現在のターンが盤面上部中央に常に明確に表示され、ユーザーは自分のターンかどうかを即座に判断できる
- **SC-004**: 無効な操作（相手のターンに駒を動かそうとする）を試みた場合、100%の確率でユーザーに視覚的フィードバックが即座に提供される
- **SC-005**: ターンベースの制御により、ユーザーは公平なゲームプレイを体験でき、両プレイヤーが交互に駒を動かせることが保証される

## Assumptions

- ゲームは常に先手から開始される（将棋の標準ルール）
- 単一デバイスでの対戦を想定（二人が同じ画面を見て交互に操作）
- ターンの切り替えは駒の移動が成功した時点で自動的に行われる
- 持ち時間やタイマー機能は本フェーチャーのスコープ外
- 駒の移動ルール（既存の003-piece-movementフェーチャー）は正しく実装されていることを前提とする
- 無効操作時のフィードバックは視覚的手段（カーソル変化、選択不可表示、アニメーション等）で提供される
- ゲーム状態の永続化は不要（ページリロード時は初期状態にリセット）
- ターン切り替えや操作イベントのログ記録は不要

## Dependencies

- **003-piece-movement**: 駒の移動ロジックが実装されている必要がある。本フェーチャーはその移動ロジックにターン制御を追加する
- **002-shogi-board-display**: 盤面と駒が正しく表示されている必要がある

## Out of Scope

- 持ち時間の管理
- オンライン対戦機能
- AI対戦
- 棋譜の記録
- 駒台への駒の追加（駒を取る機能）
- 王手や詰みの判定
- 投了や引き分けの処理
- ターン切り替えや操作イベントのログ記録・分析機能
