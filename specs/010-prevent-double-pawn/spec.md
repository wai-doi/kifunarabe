# Feature Specification: 二歩禁止ルール

**Feature Branch**: `010-prevent-double-pawn`
**Created**: 2025-12-10
**Status**: Draft
**Input**: User description: "二歩を打てないようにしたい"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 二歩を打とうとしたときに警告する (Priority: P1)

プレイヤーが持ち駒の歩を打とうとしたとき、その筋（縦の列）に既に自分の歩が存在する場合、システムは二歩として検出し、その打ち手を拒否する。プレイヤーは視覚的なフィードバックを受け取り、別の打ち手を選択できる。

**Why this priority**: 二歩は将棋の基本的な反則ルールであり、これを許可するとゲームのルールに反する。正しいゲームプレイのために最も重要な検証機能。

**Independent Test**: 同じ筋に歩が既に存在する状態で、持ち駒の歩を同じ筋に打とうとし、システムが拒否することを確認できる。

**Acceptance Scenarios**:

1. **Given** 先手が3筋に歩を配置済みで、持ち駒に歩がある、**When** 先手が3筋の任意の空きマスに持ち駒の歩を打とうとする、**Then** システムは打つ操作を拒否し、「二歩は反則です」というメッセージを表示する
2. **Given** 後手が5筋に歩を配置済みで、持ち駒に歩が2つある、**When** 後手が5筋に歩を打とうとする、**Then** システムは操作を拒否し、手番は後手のまま継続する
3. **Given** 先手が2筋に歩を配置済み、**When** 先手が4筋に歩を打とうとする、**Then** 4筋には先手の歩がないため、打つ操作が成功する
4. **Given** 先手が7筋に歩を配置済みだが、その歩が成っている（と金）、**When** 先手が7筋に持ち駒の歩を打とうとする、**Then** 成り駒は歩としてカウントされないため、打つ操作が成功する

---

### User Story 2 - 打てるマス目の視覚的表示 (Priority: P2)

プレイヤーが持ち駒の歩を選択したとき、二歩にならない筋の空きマス目のみが打てる候補として視覚的にハイライト表示される。二歩になる筋のマス目は候補として表示されない。

**Why this priority**: ユーザーエクスペリエンスを向上させる重要な機能だが、基本的な二歩検証機能の後に実装可能。

**Independent Test**: 持ち駒の歩を選択し、ハイライトされるマス目が二歩にならない筋のみであることを確認できる。

**Acceptance Scenarios**:

1. **Given** 先手が1筋、3筋、5筋に歩を配置済み、**When** 先手が持ち駒の歩を選択する、**Then** 2筋、4筋、6筋、7筋、8筋、9筋の空きマス目のみがハイライト表示される
2. **Given** 後手が全ての筋に歩を配置済み、**When** 後手が持ち駒の歩を選択する、**Then** どのマス目もハイライト表示されず、打てる場所がないことが視覚的に示される
3. **Given** 先手が3筋に成り歩（と金）を配置済み、**When** 先手が持ち駒の歩を選択する、**Then** 3筋の空きマス目もハイライト表示される（成り駒は歩扱いではないため）

---

### User Story 3 - 二歩ルールの例外処理 (Priority: P3)

成り駒（と金など）は「歩」としてカウントされないため、同じ筋に成り駒がある場合でも歩を打つことができる。また、歩が別の筋に移動した後は、元の筋に歩を打つことが可能になる。

**Why this priority**: ルールの正確性を確保する重要な要素だが、基本的な二歩検証の後に検証可能。

**Independent Test**: 成り駒が存在する筋、または駒が移動して空いた筋に歩を打つことで検証できる。

**Acceptance Scenarios**:

1. **Given** 先手が5筋にと金（成り歩）を配置済み、**When** 先手が5筋に持ち駒の歩を打つ、**Then** 打つ操作が成功する（と金は歩扱いではない）
2. **Given** 先手が4筋に歩を配置後、その歩を5筋に移動させた、**When** 先手の次の手番で4筋に歩を打つ、**Then** 4筋には歩がないため、打つ操作が成功する
3. **Given** 先手が2筋に歩を配置済みで、その歩が成ってと金になった、**When** 先手が2筋に歩を打つ、**Then** と金は歩扱いではないため、打つ操作が成功する

---

### Edge Cases

- プレイヤーが歩以外の駒（角、飛車など）を打つ場合、二歩ルールは適用されない
- 同じ筋に相手の歩がある場合でも、自分の歩がなければ歩を打つことができる
- 履歴をナビゲートして過去の局面に戻った場合、その局面での盤面状態に基づいて二歩判定が行われる
- 初期配置で既に各筋に歩がある状態から開始する場合、持ち駒に歩があっても二歩で打てない筋が存在する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、プレイヤーが持ち駒の歩を打とうとしたときに、その筋に既に同じプレイヤーの未成の歩が存在するかを検証しなければならない
- **FR-002**: システムは、二歩になる打ち手を拒否し、エラーメッセージ「二歩は反則です」をユーザーに表示しなければならない
- **FR-003**: システムは、成り駒（と金、成香、成桂、成銀、竜王、竜馬）を歩としてカウントしてはならない
- **FR-004**: システムは、歩を選択したときに、二歩にならない筋の空きマス目のみを打てる候補として表示しなければならない
- **FR-005**: システムは、歩以外の駒（王、玉、金、銀、桂馬、香車、角、飛車）を打つ際に二歩検証を行ってはならない
- **FR-006**: システムは、筋ごとに独立して二歩判定を行わなければならない（1筋から9筋まで）
- **FR-007**: システムは、相手プレイヤーの歩の存在を二歩判定に含めてはならない（自分の歩のみを対象とする）
- **FR-008**: システムは、二歩で拒否された場合、手番を変更せず、プレイヤーが別の打ち手を選択できる状態を維持しなければならない

### Key Entities

- **筋（File）**: 将棋盤の縦の列（1筋から9筋）を表す。二歩判定は筋単位で行われる
- **未成の歩**: 成っていない状態の歩駒。`promoted: false` かつ `type: '歩'` の駒
- **二歩判定結果**: 特定の筋に歩を打てるかどうかの真偽値。筋とプレイヤーの組み合わせで一意に決定される

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: プレイヤーが二歩となる打ち手を試みた場合、100%の確率でシステムが拒否し、適切なエラーメッセージを表示する
- **SC-002**: 持ち駒の歩を選択したとき、二歩にならない打てる候補マスが正確に視覚表示される（手動テストで検証可能）
- **SC-003**: 成り駒が存在する筋に歩を打つ操作が正常に成功する（ルールの正確性を確保）
- **SC-004**: 二歩検証の実行時間が50ミリ秒以内で完了し、ユーザーインタラクションを遅延させない
- **SC-005**: 全ての筋（1-9筋）で二歩判定が正しく動作することが自動テストで検証される

## Assumptions

- 持ち駒を打つ機能（006-piece-drop）が既に実装されており、`canDropPiece` 関数を拡張可能
- 盤面の駒情報には駒の種類、位置、成り状態が含まれている
- UIレイヤーでエラーメッセージを表示する仕組みが存在するか、容易に追加可能
- 打てる候補マスをハイライト表示する仕組みが既存のUI実装に存在する

## Dependencies

- 006-piece-drop（持ち駒を打つ機能）: 二歩検証は駒を打つロジックの一部として統合される
- 003-piece-movement（駒の移動機能）: 歩が移動した後の盤面状態を正しく反映する必要がある
- 007-piece-promotion（駒の成り機能）: 成り駒を歩としてカウントしないロジックに依存する

## Out of Scope

- 他の反則ルール（打ち歩詰め、行き所のない駒など）の検証
- 二歩以外の複雑なルール検証（千日手、詰み判定など）
- サーバー側での二歩検証（クライアント側の検証のみ）
- 対局中の反則履歴の記録や統計
- 二歩を試みた回数のトラッキング

## Notes

二歩は将棋の基本的な反則ルールであり、初心者でもすぐに理解できる単純なルールです。このフィーチャーは、既存の駒打ちロジック（`dropLogic.ts`）を拡張し、`canDropPiece` 関数に二歩検証を追加することで実装されます。

成り駒の扱いが重要なポイントであり、`promoted: true` の駒は歩としてカウントしないという仕様を明確にする必要があります。また、履歴ナビゲーション機能との連携も考慮し、過去の局面での盤面状態に基づいて正しく二歩判定が行われることを確認する必要があります。
