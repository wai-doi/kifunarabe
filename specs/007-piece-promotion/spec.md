# Feature Specification: 駒の成り機能

**Feature Branch**: `007-piece-promotion`
**Created**: 2025-11-30
**Status**: Draft
**Input**: User description: "駒が成れるようにしたい。自分の駒が敵陣地から移動したとき、駒を成るか選択することができる。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 敵陣に入った駒を成る (Priority: P1)

プレイヤーは自分の駒を敵陣（相手側の3段）に移動させたとき、その駒を成る（裏返す）かどうかを選択できる。成ることを選択した場合、駒は成り駒に変わり、新しい動き方ができるようになる。

**Why this priority**: 駒の成りは将棋の最も基本的かつ戦略的に重要なルールの一つ。駒を成らせることで戦力が大幅に強化され、ゲーム進行に不可欠。

**Independent Test**: 駒を敵陣に移動させた際に成りの選択ダイアログが表示され、成りを選択すると駒が成り駒に変化することを検証できる。

**Acceptance Scenarios**:

1. **Given** 先手の歩が6段目にある、**When** 先手が歩を7段目（敵陣）に進める、**Then** 「成る/成らない」の選択肢が表示される
2. **Given** 先手の歩が8段目（敵陣内）にある、**When** 先手が歩を9段目に進める、**Then** 「成る/成らない」の選択肢が表示される
3. **Given** 「成る/成らない」の選択肢が表示されている、**When** プレイヤーが「成る」を選択する、**Then** 駒が成り駒に変化し、手番が相手に移る
4. **Given** 「成る/成らない」の選択肢が表示されている、**When** プレイヤーが「成らない」を選択する、**Then** 駒は成らずにそのまま、手番が相手に移る

---

### User Story 2 - 敵陣から出た駒を成る (Priority: P1)

プレイヤーは敵陣内にある自分の駒を敵陣の外に移動させたとき、その駒を成るかどうかを選択できる。

**Why this priority**: 敵陣から出る際にも成れるのは将棋の正式ルールであり、プレイヤーに重要な選択肢を提供する。

**Independent Test**: 敵陣内にある駒を敵陣外へ移動させた際に成りの選択ダイアログが表示されることを検証できる。

**Acceptance Scenarios**:

1. **Given** 先手の銀が7段目（敵陣内）にある、**When** 先手が銀を6段目（敵陣外）に移動する、**Then** 「成る/成らない」の選択肢が表示される
2. **Given** 後手の飛車が3段目（敵陣内）にある、**When** 後手が飛車を4段目（敵陣外）に移動する、**Then** 「成る/成らない」の選択肢が表示される

---

### User Story 3 - 成り駒の動きの変化 (Priority: P1)

成った駒は新しい動き方ができるようになる。歩・香・桂・銀は金と同じ動きになり、飛車は竜（龍王）に、角は馬（龍馬）になる。

**Why this priority**: 成り駒の動き方の変化は成り機能の本質であり、これなしでは成る意味がない。

**Independent Test**: 各駒種を成らせた後、正しい移動パターンで移動できることを検証できる。

**Acceptance Scenarios**:

1. **Given** 先手の歩が成って「と金」になった、**When** と金の移動可能なマス目を確認する、**Then** 金将と同じ6方向に移動可能（前3方向、横2方向、後ろ1方向）
2. **Given** 先手の香車が成って「成香」になった、**When** 成香の移動可能なマス目を確認する、**Then** 金将と同じ動きが可能
3. **Given** 先手の桂馬が成って「成桂」になった、**When** 成桂の移動可能なマス目を確認する、**Then** 金将と同じ動きが可能
4. **Given** 先手の銀将が成って「成銀」になった、**When** 成銀の移動可能なマス目を確認する、**Then** 金将と同じ動きが可能
5. **Given** 先手の飛車が成って「竜王（竜）」になった、**When** 竜の移動可能なマス目を確認する、**Then** 飛車の動き（縦横直進）に加えて斜め1マスへの移動が可能
6. **Given** 先手の角行が成って「竜馬（馬）」になった、**When** 馬の移動可能なマス目を確認する、**Then** 角の動き（斜め直進）に加えて縦横1マスへの移動が可能

---

### User Story 4 - 成れない駒と強制成り (Priority: P2)

金将と王将（玉将）は成ることができない。また、行き場所がなくなる駒（歩・香が最奥段、桂馬が最奥2段）は強制的に成らなければならない。

**Why this priority**: 成れない駒のルールと強制成りは将棋の正式ルールであり、ゲームの整合性を保つために必要。

**Independent Test**: 金将や王将を敵陣に移動させた際に成りの選択が表示されないこと、および強制成りの条件で自動的に成ることを検証できる。

**Acceptance Scenarios**:

1. **Given** 先手の金将が6段目にある、**When** 先手が金将を7段目（敵陣）に進める、**Then** 成りの選択肢は表示されず、そのまま手番が相手に移る
2. **Given** 先手の王将が6段目にある、**When** 先手が王将を7段目（敵陣）に進める、**Then** 成りの選択肢は表示されず、そのまま手番が相手に移る
3. **Given** 先手の歩が8段目（敵陣内）にある、**When** 先手が歩を9段目（最奥段）に進める、**Then** 成りの選択肢なしで自動的に成り駒に変化する
4. **Given** 先手の香車が8段目にある、**When** 先手が香車を9段目（最奥段）に進める、**Then** 自動的に成香に変化する
5. **Given** 先手の桂馬が7段目にある、**When** 先手が桂馬を9段目（跳ねて最奥段）に進める、**Then** 自動的に成桂に変化する
6. **Given** 先手の桂馬が6段目にある、**When** 先手が桂馬を8段目に進める、**Then** 「成る/成らない」の選択肢が表示される（8段目からはまだ動けるため）

---

### User Story 5 - 成り駒の表示 (Priority: P2)

成り駒は視覚的に区別できるように表示される。成り駒は通常の駒とは異なる表記（と、成香、成桂、成銀、竜、馬）で表示される。

**Why this priority**: ユーザーが盤面の状態を正しく理解するためには、成り駒が視覚的に識別できる必要がある。

**Independent Test**: 成り駒が正しい表記で表示されることを検証できる。

**Acceptance Scenarios**:

1. **Given** 歩が成った、**When** 盤面を確認する、**Then** 「と」と表示される
2. **Given** 香車が成った、**When** 盤面を確認する、**Then** 「杏」と表示される
3. **Given** 桂馬が成った、**When** 盤面を確認する、**Then** 「圭」と表示される
4. **Given** 銀将が成った、**When** 盤面を確認する、**Then** 「全」と表示される
5. **Given** 飛車が成った、**When** 盤面を確認する、**Then** 「竜」と表示される
6. **Given** 角行が成った、**When** 盤面を確認する、**Then** 「馬」と表示される

---

### Edge Cases

- すでに成っている駒を移動した場合、再度成りの選択は表示されない（成り駒は再度成れない）
- 敵陣内での移動（敵陣から敵陣への移動）でも成りを選択できる
- 持ち駒を打った際は、敵陣であっても成りの選択は発生しない（打った駒は成れない）
- 成り駒が取られた場合、持ち駒となる際は成る前の駒種に戻る（例：と金→歩）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、駒が敵陣（相手側3段）に入った際に成りの選択肢を表示しなければならない
- **FR-002**: システムは、駒が敵陣から出た際に成りの選択肢を表示しなければならない
- **FR-003**: システムは、駒が敵陣内で移動した際に成りの選択肢を表示しなければならない
- **FR-004**: システムは、金将と王将（玉将）については成りの選択肢を表示してはならない
- **FR-005**: システムは、行き場所がなくなる移動（歩・香が最奥段、桂馬が最奥2段）の場合、自動的に駒を成らせなければならない
- **FR-006**: システムは、成り駒の移動パターンを正しく計算しなければならない（歩・香・桂・銀→金の動き、飛→竜、角→馬）
- **FR-007**: システムは、成り駒を視覚的に区別できる形式で表示しなければならない
- **FR-008**: システムは、すでに成っている駒については成りの選択肢を表示してはならない
- **FR-009**: システムは、持ち駒を打った際には成りの選択肢を表示してはならない
- **FR-010**: システムは、成りの選択が完了するまで手番を移動してはならない
- **FR-011**: システムは、成り駒が取られた場合、成る前の駒種として持ち駒に追加しなければならない

### Key Entities *(include if feature involves data)*

- **成り駒 (Promoted Piece)**: 成った状態の駒。既存のPiece型に`promoted: boolean`フラグを追加して表現する
- **敵陣 (Enemy Territory)**: 相手側の3段。先手にとっては7-9段目、後手にとっては1-3段目
- **成り選択 (Promotion Choice)**: 成るか成らないかの選択状態。移動完了前に解決が必要
- **成り駒種 (Promoted Piece Type)**: と、杏、圭、全、竜、馬の6種類（一文字表示で統一）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: プレイヤーは成り条件を満たした移動の際、2クリック以内で成る/成らないを選択できる
- **SC-002**: 成り駒は100%正しい移動パターンで動作する（各成り駒種のテストケースをすべてパス）
- **SC-003**: 強制成りが必要な移動では100%自動的に成りが適用される
- **SC-004**: 成れない駒（金、王/玉、すでに成っている駒）では成り選択が表示されない
- **SC-005**: 成り駒が取られた際、100%の確率で正しい元の駒種として持ち駒に追加される

## Assumptions

- 駒の表示には、一般的な将棋の表記法を使用する（と金は「と」、竜王は「竜」など）
- 成り選択のUIは移動先のマス目付近にポップアップ表示する
- 現在実装済みの駒の移動ロジック（moveRules.ts）を拡張して成り駒の移動パターンを追加する
- 駒のデータ構造（Piece型）に`promoted: boolean`フラグを追加して成り状態を管理する

## Clarifications

### Session 2025-11-30

- Q: 成り駒の表示文字は一文字と二文字どちらで統一するか → A: 一文字表示（と、杏、圭、全、竜、馬）で統一
- Q: 成り選択UIの表示位置はどこにするか → A: 移動先のマス目付近にポップアップ表示
- Q: 成り駒のデータ表現方法はどうするか → A: 既存のPieceにpromotedフラグを追加（promoted: boolean）
