# Feature Specification: 手順の巻き戻し・再生機能

**Feature Branch**: `008-move-history-navigation`
**Created**: 2025-12-08
**Status**: Draft
**Input**: User description: "手を戻せるようにしたい。初手に戻る、一手戻る、一手進む、最終手に進む動作をする4つのボタンがある。手を戻すと盤面と持ち駒の状態がその戻ったもしくは進んだ手のときの状態になる。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 一手戻る操作 (Priority: P1)

ユーザーは「一手戻る」ボタンをクリックすることで、直前に指された手を取り消し、その一手前の盤面状態と持ち駒の状態に戻ることができます。これにより、手順を確認したり、別の手を試したりすることが可能になります。

**Why this priority**: 棋譜を再生・検討する上で最も頻繁に使用される基本操作です。この機能だけでも「手を戻して確認する」という価値を提供できるため、MVP として最優先で実装すべきです。

**Independent Test**: 何手か駒を動かした後、「一手戻る」ボタンをクリックすると盤面が一手前の状態に戻ることを確認できます。持ち駒がある場合は持ち駒も一手前の状態に戻ります。この機能単独で独立したテストが可能です。

**Acceptance Scenarios**:

1. **Given** 初期配置から3手進んだ状態、**When** ユーザーが「一手戻る」ボタンをクリックする、**Then** 盤面が2手目の状態に戻り、手番表示も2手目に対応した状態になる
2. **Given** 駒を取った直後の状態(持ち駒がある)、**When** ユーザーが「一手戻る」ボタンをクリックする、**Then** 取られた駒が盤面に戻り、持ち駒から削除される
3. **Given** 駒を成った直後の状態、**When** ユーザーが「一手戻る」ボタンをクリックする、**Then** 駒が成る前の状態に戻る
4. **Given** 初期配置の状態(0手目)、**When** ユーザーが「一手戻る」ボタンをクリックする、**Then** 何も起こらない、またはボタンが無効化されている

---

### User Story 2 - 一手進む操作 (Priority: P1)

ユーザーは「一手進む」ボタンをクリックすることで、一度戻った手順を一手ずつ再生し、次の手の盤面状態と持ち駒の状態に進むことができます。これにより、手順を順番に確認できます。

**Why this priority**: 「一手戻る」と対をなす基本操作であり、手順を前後に移動して確認するために必須です。戻った手順を再度進めるために不可欠な機能です。

**Independent Test**: 何手か戻した後、「一手進む」ボタンをクリックすると盤面が一手先の状態に進むことを確認できます。最終手まで到達したら進めなくなることも確認します。

**Acceptance Scenarios**:

1. **Given** 5手目まで進んだ後3手目まで戻った状態、**When** ユーザーが「一手進む」ボタンをクリックする、**Then** 盤面が4手目の状態に進む
2. **Given** 最終手まで進んだ状態、**When** ユーザーが「一手進む」ボタンをクリックする、**Then** 何も起こらない、またはボタンが無効化されている
3. **Given** 3手目まで戻った状態、**When** ユーザーが「一手進む」ボタンを2回クリックする、**Then** 盤面が5手目の状態に進む

---

### User Story 3 - 初手に戻る操作 (Priority: P2)

ユーザーは「初手に戻る」ボタンをクリックすることで、現在の手数に関わらず一度に初期配置(0手目)の状態に戻ることができます。これにより、最初から手順を確認し直すことができます。

**Why this priority**: 一手ずつ戻る操作の繰り返しで実現できますが、手数が多い場合の利便性向上のための機能です。基本機能が実装された後に追加すべき補助機能として P2 としています。

**Independent Test**: 任意の手数まで進んだ状態から「初手に戻る」ボタンをクリックすると、一度に初期配置に戻ることを確認できます。

**Acceptance Scenarios**:

1. **Given** 10手目まで進んだ状態、**When** ユーザーが「初手に戻る」ボタンをクリックする、**Then** 盤面が初期配置(0手目)に戻り、持ち駒も空の状態になる
2. **Given** 初期配置の状態(0手目)、**When** ユーザーが「初手に戻る」ボタンをクリックする、**Then** 何も変化しない、またはボタンが無効化されている
3. **Given** 持ち駒がある状態、**When** ユーザーが「初手に戻る」ボタンをクリックする、**Then** すべての持ち駒がクリアされ、盤面が初期配置に戻る

---

### User Story 4 - 最終手に進む操作 (Priority: P2)

ユーザーは「最終手に進む」ボタンをクリックすることで、現在の手数に関わらず一度に最終手(最後に指された手)の状態まで進むことができます。これにより、途中から最終局面まで素早く移動できます。

**Why this priority**: 一手ずつ進む操作の繰り返しで実現できますが、手数が多い場合の利便性向上のための機能です。基本機能が実装された後に追加すべき補助機能として P2 としています。

**Independent Test**: 初手や途中の手数から「最終手に進む」ボタンをクリックすると、一度に最終手の状態に進むことを確認できます。

**Acceptance Scenarios**:

1. **Given** 初期配置から5手進んだ後、3手目まで戻った状態、**When** ユーザーが「最終手に進む」ボタンをクリックする、**Then** 盤面が5手目(最終手)の状態に進む
2. **Given** 初期配置の状態(0手目)、**When** ユーザーが「最終手に進む」ボタンをクリックする、**Then** 最終手まで一度に進む
3. **Given** 最終手の状態、**When** ユーザーが「最終手に進む」ボタンをクリックする、**Then** 何も変化しない、またはボタンが無効化されている

---

### Edge Cases

- 初期配置(0手目)の状態で「一手戻る」または「初手に戻る」ボタンをクリックした場合、操作は無効となる、またはボタンが無効化される
- 最終手の状態で「一手進む」または「最終手に進む」ボタンをクリックした場合、操作は無効となる、またはボタンが無効化される
- 手順を戻った状態から新しい手を指した場合、その手以降の履歴は削除される(分岐は作成されない)
- 成った駒を戻す場合、成る前の駒種に正しく戻る
- 持ち駒を使って指した手を戻す場合、持ち駒が正しく復元される
- 複数の駒が取られた複雑な局面でも、正しい順序で駒が戻る・進む

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、指された手の履歴を順番に記録し、いつでも参照できるようにしなければならない
- **FR-002**: システムは、各手の盤面状態(81マスの駒配置)を記録しなければならない
- **FR-003**: システムは、各手の持ち駒の状態(先手・後手それぞれの持ち駒リスト)を記録しなければならない
- **FR-004**: システムは、各手の手番(先手・後手)を記録しなければならない
- **FR-005**: システムは、「一手戻る」ボタンを提供し、クリック時に直前の手を取り消して一手前の状態に戻らなければならない
- **FR-006**: システムは、「一手進む」ボタンを提供し、クリック時に次の手の状態に進まなければならない
- **FR-007**: システムは、「初手に戻る」ボタンを提供し、クリック時に初期配置(0手目)に戻らなければならない
- **FR-008**: システムは、「最終手に進む」ボタンを提供し、クリック時に記録された最終手の状態に進まなければならない
- **FR-009**: システムは、現在の手数と最大手数を表示しなければならない(例: "3手目 / 10手")
- **FR-010**: システムは、初期配置の状態では「一手戻る」「初手に戻る」ボタンを無効化しなければならない
- **FR-011**: システムは、最終手の状態では「一手進む」「最終手に進む」ボタンを無効化しなければならない
- **FR-012**: システムは、手順を戻った状態から新しい手を指した場合、その手以降の履歴を削除しなければならない
- **FR-013**: システムは、駒を成った手を戻す場合、駒を成る前の状態に正しく戻さなければならない
- **FR-014**: システムは、駒を取った手を戻す場合、取られた駒を正しい位置に復元し、持ち駒から削除しなければならない
- **FR-015**: システムは、持ち駒を打った手を戻す場合、打たれた駒を盤面から削除し、持ち駒に戻さなければならない

### Key Entities

- **手履歴(MoveHistory)**: 指された手の順序付きリスト。各エントリには手番、移動元、移動先、駒種、成ったかどうか、取った駒の情報が含まれる
- **盤面スナップショット(BoardSnapshot)**: 特定の手数における盤面の完全な状態。81マスの駒配置、持ち駒リスト、手番情報を含む
- **現在位置(CurrentPosition)**: 手履歴内での現在の位置(インデックス)。0が初期配置、最大値が最終手を表す

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは「一手戻る」「一手進む」ボタンで、1秒以内に隣接する手に移動できる
- **SC-002**: ユーザーは「初手に戻る」「最終手に進む」ボタンで、手数に関わらず1秒以内に目的の手に移動できる
- **SC-003**: 100手以上の手順がある場合でも、ナビゲーション操作が遅延なく実行される
- **SC-004**: 手を戻した後、盤面と持ち駒が正しい状態(その手の時点の状態)に100%正確に復元される
- **SC-005**: ボタンの有効/無効状態が現在の手数に応じて正しく表示される(ユーザーが無効な操作を試みることを防ぐ)
- **SC-006**: 手順を戻った状態から新しい手を指した場合、以降の履歴が適切に削除され、矛盾が発生しない
