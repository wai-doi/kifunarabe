# Feature Specification: 持ち駒を打つ機能

**Feature Branch**: `006-piece-drop`
**Created**: 2025-11-29
**Status**: Draft
**Input**: User description: "取った駒を盤上に打てるようにしたい。自分の駒を一回動かす代わりに、自分の持ち駒を開いているマスに打つことができる。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 持ち駒を空きマスに打つ (Priority: P1)

プレイヤーは自分の手番で、盤上の駒を動かす代わりに、持ち駒エリアから駒を選択して盤上の空いているマス目に配置（打つ）することができる。打った駒は自分の駒として盤面に存在し、以降は通常の駒として移動できる。

**Why this priority**: これは将棋の最も特徴的なルールの一つであり、持ち駒の活用によって戦略性が大幅に向上する。005-piece-captureで実装した持ち駒機能を活かすための必須機能。

**Independent Test**: 持ち駒を持っている状態で、持ち駒エリアから駒を選択し、空いているマス目に配置することで、駒打ち機能を独立して検証できる。

**Acceptance Scenarios**:

1. **Given** 先手が歩を1つ持ち駒として持っている、**When** 先手が持ち駒の歩を選択し、空いているマス目をクリックする、**Then** 歩がそのマス目に先手の駒として配置され、持ち駒から歩が1つ減る
2. **Given** 後手が角を持ち駒として持っている、**When** 後手の手番で持ち駒の角を選択し、空いているマス目に打つ、**Then** 角がそのマス目に後手の駒として配置され、持ち駒から角が減る
3. **Given** 先手が歩を3つ持ち駒として持っている、**When** 先手が持ち駒の歩を1つ打つ、**Then** 持ち駒の歩が2つに減り、打った歩が盤面に配置される
4. **Given** プレイヤーが持ち駒を打った、**When** 打つ操作が完了する、**Then** 手番が相手に移る

---

### User Story 2 - 持ち駒の選択と配置先の指定 (Priority: P1)

プレイヤーは持ち駒エリアに表示されている自分の駒をクリックして選択状態にし、その後盤面上の空いているマス目をクリックすることで打つ位置を指定する。駒を動かす操作と持ち駒を打つ操作の両方が自然に行えるようにする。

**Why this priority**: 持ち駒を打つためのUIインタラクションは、機能を使用するために必須であり、ユーザーが直感的に操作できる必要がある。

**Independent Test**: 持ち駒エリアをクリックして駒を選択し、盤面上の空きマスをクリックして打つまでの一連の操作を検証できる。

**Acceptance Scenarios**:

1. **Given** 先手が持ち駒を持っている、**When** 先手が自分の持ち駒エリアの駒をクリックする、**Then** その駒が選択状態になり、視覚的にハイライトされる
2. **Given** 持ち駒が選択されている、**When** 盤面上の空いているマス目をクリックする、**Then** 選択された駒がそのマス目に配置される
3. **Given** 持ち駒が選択されている、**When** 盤面上の駒が置かれているマス目をクリックする、**Then** 打つ操作は実行されない（駒がある場所には打てない）
4. **Given** 持ち駒が選択されている、**When** 別の持ち駒をクリックする、**Then** 選択が新しい駒に切り替わる
5. **Given** 持ち駒が選択されている、**When** 盤面上の自分の駒をクリックする、**Then** 持ち駒の選択が解除され、盤面の駒が選択状態になる

---

### User Story 3 - 手番と持ち駒打ちの連携 (Priority: P2)

自分の手番でのみ持ち駒を打つことができる。相手の手番では持ち駒を選択したり打ったりすることはできない。

**Why this priority**: ターン制御との連携は必須だが、基本的な打つ機能が動作した後に検証可能。

**Independent Test**: 先手・後手それぞれの手番で、持ち駒を打てるか/打てないかを検証できる。

**Acceptance Scenarios**:

1. **Given** 先手の手番で、先手が持ち駒を持っている、**When** 先手が持ち駒を選択して空きマスに打つ、**Then** 打つ操作が成功し、手番が後手に移る
2. **Given** 先手の手番で、後手が持ち駒を持っている、**When** 後手が自分の持ち駒エリアの駒をクリックする、**Then** 駒は選択されない（相手の手番では操作不可）
3. **Given** 後手の手番で、後手が持ち駒を持っている、**When** 後手が持ち駒を選択して空きマスに打つ、**Then** 打つ操作が成功し、手番が先手に移る

---

### Edge Cases

- 持ち駒が0個の場合、持ち駒エリアからの選択操作はどうなるか?（何も選択できない）
- 盤面に空きマスがない場合（理論上ほぼありえないが）、駒を打てないことが正しく処理されるか?
- 持ち駒を選択した状態で盤面外（持ち駒エリア外かつ盤面外）をクリックした場合、選択が解除されるか?
- 持ち駒を選択してから打つまでの間に、選択をキャンセルしたい場合はどうするか?（同じ持ち駒をもう一度クリックするか、盤面外をクリックで解除）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、プレイヤーが自分の持ち駒を選択できるようにしなければならない
- **FR-002**: システムは、選択された持ち駒を視覚的にハイライト表示しなければならない
- **FR-003**: システムは、選択された持ち駒を盤上の空いているマス目にのみ配置できるようにしなければならない
- **FR-004**: システムは、持ち駒を打った後、その駒を持ち駒リストから削除しなければならない
- **FR-005**: システムは、打たれた駒を、打ったプレイヤーの所有する駒として盤面に配置しなければならない
- **FR-006**: システムは、持ち駒を打った後、手番を相手に移さなければならない
- **FR-007**: システムは、自分の手番でのみ持ち駒を選択・打つ操作を許可しなければならない
- **FR-008**: システムは、盤面の駒を動かす操作と持ち駒を打つ操作を両方サポートし、ユーザーがシームレスに切り替えられるようにしなければならない
- **FR-009**: システムは、既に駒が配置されているマス目には持ち駒を打てないようにしなければならない
- **FR-010**: システムは、持ち駒の選択をキャンセルする手段を提供しなければならない

### Key Entities *(include if feature involves data)*

- **持ち駒 (Captured Pieces)**: プレイヤーが取った駒のコレクション。005-piece-captureで実装済みの構造を使用
- **選択状態 (Selection State)**: 現在選択されている駒（盤面上の駒または持ち駒）を管理する状態
- **打つ操作 (Drop Action)**: 持ち駒を盤面に配置する操作。移動先の座標と打つ駒の種類を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: プレイヤーは持ち駒を選択し、空いているマス目に打つ操作を3クリック以内で完了できる
- **SC-002**: 打たれた駒は100%の確率で正しいプレイヤーの所有として盤面に配置される
- **SC-003**: 持ち駒を打った後、持ち駒の数量が正しく減少する（誤差なし）
- **SC-004**: 持ち駒を打つ操作と盤面の駒を動かす操作が競合なく共存できる
- **SC-005**: 自分の手番でのみ持ち駒を打つ操作が可能であり、相手の手番では操作がブロックされる

## Assumptions

- 将棋の正式なルール（二歩禁止、打ち歩詰め禁止、行き所のない駒の禁止など）は、このフェーズでは実装しない。これらは将来のフェーズで追加される想定
- 成り駒（と金、竜、馬など）を持ち駒として持っている場合、打つときは成る前の元の駒種（歩、飛、角など）として扱う想定だが、現時点では成り駒機能自体が未実装のため考慮不要
- 005-piece-captureで実装された持ち駒の管理構造（CapturedPieces型）をそのまま使用する
