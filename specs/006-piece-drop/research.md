# Research: 持ち駒を打つ機能

**Feature**: 006-piece-drop
**Date**: 2025-11-29

## 調査項目

### 1. 選択状態の拡張方法

**課題**: 現在の選択状態は盤面上の駒位置（Position型）のみを管理している。持ち駒を選択できるようにするには、選択状態を拡張する必要がある。

**決定**: 選択状態を「盤面上の駒」と「持ち駒」の2種類を区別できる型に拡張する

**根拠**:
- 現在の `selected: Position | null` を `Selection` 型に変更
- Selection型は「種類(盤面/持ち駒)」「位置または駒種」「プレイヤー」を持つ
- 既存の盤面駒選択ロジックを壊さずに拡張可能

**検討した代替案**:
1. 2つの別々のstate (`selectedPiece`, `selectedCaptured`) を持つ案
   - 却下理由: 同時選択の防止ロジックが複雑になる
2. 持ち駒選択時に仮想的なPosition（例: file=0）を使う案
   - 却下理由: 型安全性が失われ、バグの温床になる

### 2. 持ち駒から駒を削除するロジック

**課題**: 持ち駒を打つ際、持ち駒リストから1つ減らす必要がある。

**決定**: 既存の `captureLogic.ts` に `removeFromCapturedPieces` 関数を追加する

**根拠**:
- `addToCapturedPieces` と対になる関数として設計
- イミュータブルな操作を維持
- 持ち駒操作のロジックを1ファイルにまとめる

**検討した代替案**:
1. 新規ファイル `dropLogic.ts` に追加する案
   - 却下理由: 持ち駒操作のロジックが分散する
2. `capturedPieces.ts` 型定義ファイルに追加する案
   - 却下理由: 型定義と実装ロジックは分離すべき

### 3. 持ち駒コンポーネントのクリック処理

**課題**: 現在の `CapturedPieces.tsx` は表示のみでクリック操作をサポートしていない。

**決定**: `CapturedPieces` コンポーネントに `onPieceClick` プロパティを追加する

**根拠**:
- 既存の表示ロジックを維持しつつ、オプショナルにクリックハンドラを追加
- プレイヤー種別（先手/後手）と駒種を親コンポーネントに通知
- 手番制御は親コンポーネント（ShogiBoard）が担当

**検討した代替案**:
1. 別コンポーネント `SelectableCapturedPieces` を作る案
   - 却下理由: コードの重複が発生する
2. 持ち駒表示部分を個別コンポーネントに分割する案
   - 保留: 将来の拡張（ドラッグ&ドロップ）時に再検討

### 4. 打つ先の有効性チェック

**課題**: 持ち駒を打てるのは空きマスのみ。既存の駒がある場所には打てない。

**決定**: `dropLogic.ts` に `canDropPiece` 関数を作成する

**根拠**:
- 駒の移動ルール（isValidMove）とは別のロジック
- 将来的な拡張（二歩禁止など）のためにファイルを分離
- 単純な空きマスチェックから開始し、段階的に拡張

**検討した代替案**:
1. `moveRules.ts` に追加する案
   - 却下理由: 移動と打つは異なる操作であり、ファイルの責務を明確にする
2. `boardState.ts` に追加する案
   - 却下理由: boardStateは盤面の更新に集中すべき

### 5. ShogiBoard での統合

**課題**: 盤面駒の移動と持ち駒を打つ操作を統合的に扱う必要がある。

**決定**: `handleSquareClick` と新規 `handleCapturedPieceClick` を分離し、選択状態を共有する

**根拠**:
- 持ち駒クリック時: 選択状態を持ち駒選択に変更
- 盤面クリック時: 持ち駒選択中なら打つ処理、盤面駒選択中なら移動処理
- 選択状態の型で分岐することで、処理を明確に分離

**検討した代替案**:
1. すべての処理を1つのハンドラにまとめる案
   - 却下理由: ハンドラが肥大化し、可読性が低下

## 依存関係の確認

### 既存コード再利用

| 既存コード | 再利用方法 |
|------------|------------|
| `CapturedPieces` 型 | そのまま使用 |
| `CapturedPiecesMap` 型 | そのまま使用 |
| `addToCapturedPieces` | 参考にして `removeFromCapturedPieces` を作成 |
| `createEmptyCapturedPieces` | そのまま使用 |
| `switchTurn` | 打った後のターン切り替えに使用 |

### 新規作成

| ファイル | 内容 |
|----------|------|
| `types/selection.ts` | 選択状態の型定義 |
| `logic/dropLogic.ts` | 持ち駒を打つロジック |

## テスト戦略

### ユニットテスト

1. **dropLogic.test.ts**
   - `canDropPiece`: 空きマスへの配置可否
   - `canDropPiece`: 駒があるマスへの配置不可
   - `dropPiece`: 盤面への駒追加

2. **captureLogic.test.ts (追加)**
   - `removeFromCapturedPieces`: 持ち駒の削除
   - `removeFromCapturedPieces`: 0個の駒は削除しない

### 統合テスト

1. **ShogiBoard.test.tsx (追加)**
   - 持ち駒選択→盤面クリック→駒配置の一連のフロー
   - 持ち駒選択→駒があるマスクリック→配置されない
   - 持ち駒打ち後のターン切り替え
   - 相手の持ち駒は選択不可

2. **CapturedPieces.test.tsx (追加)**
   - 持ち駒クリックでコールバック呼び出し
   - 選択状態のハイライト表示
