# Feature Specification: 駒の移動機能

**Feature Branch**: `003-piece-movement`
**Created**: 2025-11-01
**Status**: Draft
**Input**: User description: "駒の移動ができること。駒をクリックして移動先のマス目をクリックすると移動できる。選択中の駒は見た目でわかりやすくする。駒が成ることはまだ考慮しない。その駒の動きで移動できないマスには移動できない。駒があるマスにはまだ移動できない。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 駒の選択と移動 (Priority: P1)

ユーザーは盤面上の駒をクリックして選択し、移動可能なマスをクリックすることで、その駒を移動できます。これは将棋の基本操作であり、ゲームを進めるために不可欠な機能です。

**Why this priority**: 駒を動かすことは将棋の最も基本的な操作であり、この機能がなければゲームが成立しません。MVP(Minimum Viable Product)として最優先で実装すべき機能です。

**Independent Test**: 盤面を表示し、任意の駒をクリックして選択状態にし、移動可能なマスをクリックして駒が移動することを確認できます。この機能だけで「駒を動かす」という価値を提供できます。

**Acceptance Scenarios**:

1. **Given** 初期配置の盤面が表示されている、**When** ユーザーが先手の歩をクリックする、**Then** その駒が選択状態になり、視覚的に強調表示される
2. **Given** 駒が選択されている、**When** ユーザーがその駒の移動可能なマスをクリックする、**Then** 駒が移動先のマスに移動し、元のマスは空になる
3. **Given** 駒が選択されている、**When** ユーザーが別の自分の駒をクリックする、**Then** 前の駒の選択が解除され、新しい駒が選択される
4. **Given** 駒が選択されている、**When** ユーザーが空白のマスや盤外をクリックする、**Then** 駒の選択が解除される

---

### User Story 2 - 移動ルールの制約 (Priority: P1)

システムは各駒の動きに応じて移動可能なマスを制限し、ユーザーが将棋のルールに反する移動を行えないようにします。

**Why this priority**: 正しいルールに従わない将棋は意味がありません。駒の選択と同時に実装すべき必須機能です。P1として駒の選択と一体的に実装されるべきです。

**Independent Test**: 各種類の駒を選択し、その駒が移動できないマス(ルール違反となるマス)をクリックしても移動しないことを確認できます。例えば、歩を横に動かそうとしても移動できないことを確認します。

**Acceptance Scenarios**:

1. **Given** 歩が選択されている、**When** ユーザーが前方以外のマス(横、後ろ、斜め)をクリックする、**Then** 駒は移動せず、選択状態が維持される
2. **Given** 飛車が選択されている、**When** ユーザーが縦横方向以外のマス(斜め)をクリックする、**Then** 駒は移動せず、選択状態が維持される
3. **Given** 角が選択されている、**When** ユーザーが斜め方向以外のマス(縦横)をクリックする、**Then** 駒は移動せず、選択状態が維持される
4. **Given** 金が選択されている、**When** ユーザーが移動可能な6方向以外のマス(後ろ斜め)をクリックする、**Then** 駒は移動せず、選択状態が維持される

---

### User Story 3 - 駒がある位置への移動制限 (Priority: P2)

システムは既に駒が存在するマスへの移動を禁止します。これにより、駒の取り合い機能を実装する前の段階でも、盤面の整合性が保たれます。

**Why this priority**: 駒の取り合いは将来実装予定の機能であり、現段階では駒がある位置への移動を単純に禁止することで、バグや予期しない動作を防ぎます。

**Independent Test**: 駒を動かして、他の駒が既に存在するマスに移動しようとしても移動できないことを確認できます。

**Acceptance Scenarios**:

1. **Given** 飛車が選択されている、**When** ユーザーがその飛車の移動経路上にある自分の駒のマスをクリックする、**Then** 駒は移動せず、選択状態が維持される
2. **Given** 角が選択されている、**When** ユーザーがその角の移動経路上にある相手の駒のマスをクリックする、**Then** 駒は移動せず、選択状態が維持される(現段階では駒を取ることはできない)

---

### Edge Cases

- 駒が選択されていない状態で空のマスをクリックした場合、何も起こらない
- 盤面の端にある駒を選択した場合、盤外に移動できない(移動可能なマスのみが有効)
- 飛車や角などの遠距離移動駒の場合、移動経路上に他の駒がある場合、その手前までしか移動できない
- 同じ駒を2回クリックした場合、選択が解除される
- 移動後、選択状態は自動的に解除される

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、ユーザーがクリックした駒を選択状態にしなければならない
- **FR-002**: システムは、選択中の駒を視覚的に識別可能な状態で表示しなければならない(例: ハイライト、枠線、色の変更など)
- **FR-003**: システムは、選択された駒が移動可能なマスにのみ移動できるようにしなければならない
- **FR-004**: システムは、各駒種(歩、香、桂、銀、金、飛、角、王)の移動ルールに従って移動可能なマスを判定しなければならない
- **FR-005**: システムは、駒が既に存在するマスへの移動を禁止しなければならない
- **FR-006**: システムは、選択中の駒以外の駒をクリックした場合、前の選択を解除し、新しい駒を選択しなければならない
- **FR-007**: システムは、空のマスまたは盤外をクリックした場合、駒の選択を解除しなければならない
- **FR-008**: システムは、駒が移動した後、その駒の選択状態を解除しなければならない
- **FR-009**: システムは、移動不可能なマスをクリックした場合、駒を移動させず、選択状態を維持しなければならない
- **FR-010**: システムは、飛車や角などの長距離移動駒の場合、移動経路上に他の駒がある場合は、その直前のマスまでしか移動できないようにしなければならない

### Key Entities

- **選択状態**: どの駒が現在選択されているか(駒の位置情報、または選択なし)
- **駒の位置**: 盤面上の各駒がどのマス(行・列)に存在するか
- **移動可能マス**: 選択された駒が移動できるマスの集合(駒の種類と現在位置、および盤面の状態から動的に計算される)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーが駒をクリックしてから選択状態が視覚的に表示されるまでの時間が0.1秒以内である
- **SC-002**: ユーザーが移動先のマスをクリックしてから駒が移動完了するまでの時間が0.2秒以内である
- **SC-003**: 将棋のルールに従った駒の移動において、100%の精度でルール違反を検出し、移動を禁止する
- **SC-004**: テストユーザーの90%以上が、選択中の駒を視覚的に識別できる
- **SC-005**: テストユーザーの90%以上が、駒の選択と移動の操作を初回使用時に理解できる
