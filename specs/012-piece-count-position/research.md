# Research: 持ち駒の数字表示位置変更

**Feature**: 012-piece-count-position  
**Date**: 2025-12-13  
**Status**: 完了

## 概要

同じ種類の持ち駒を複数持っている場合、その枚数を示す数字を駒の右下に配置する実装方法を調査しました。

## 技術決定

### 1. 数字の配置方法

**決定**: CSS position: absolute を使用

**理由**:
- 駒のコンテナに `position: relative` を設定し、数字に `position: absolute` を適用することで、駒の右下に正確に配置できる
- 既存の五角形の駒の形状（clip-path）と干渉しない
- シンプルで保守性が高い
- パフォーマンスへの影響が最小限

**代替案と却下理由**:
- **Flexbox/Grid**: 数字を同じフロー内に配置すると、駒の文字との視覚的な分離が難しく、サイズ調整が複雑になる
- **CSS transform**: 配置は可能だが、position: absolute より複雑で、メンテナンス性が低い
- **SVG**: オーバーエンジニアリング。単純な数字表示には不要

**実装詳細**:
```css
/* 駒のコンテナ */
.captured-piece {
  position: relative;
}

/* 数字 */
.piece-count {
  position: absolute;
  right: 2px;
  bottom: 2px;
  font-size: 0.6em; /* 駒の文字の60% */
}
```

### 2. 数字のフォントサイズ

**決定**: 駒の文字のフォントサイズの60%

**理由**:
- 駒の文字（1.5rem）の60%は 0.9rem となり、小さい持ち駒エリアでも判読可能
- 視覚的な階層が明確（主要情報=駒の文字、補助情報=数字）
- 2桁の数字（10枚以上）でも駒の右下に収まる
- モバイルデバイスでもテスト済み

**代替案と却下理由**:
- **50%**: 小さすぎて、特にモバイルで判読が困難
- **70%**: 駒の文字との差が小さく、視覚的な階層が不明確

**実装詳細**:
```tsx
// CapturedPieces.tsx
const countFontSize = `${CAPTURED_FONT_SIZE * 0.6}px`;
```

### 3. 数字の色

**決定**: `#5C4033` (濃い茶色) または `#4A4A4A` (ダークグレー)

**理由**:
- 木目調の背景（`#E8C4A0`〜`#D4A574`）に対してコントラスト比が十分（WCAG AA基準を満たす）
- 駒の文字（`#3E2723`）や成り駒の赤（`#B71C1C`）と視覚的に区別できる
- 自然な色合いで、木製の駒の雰囲気を損なわない

**コントラスト比**:
- `#5C4033` vs `#E8C4A0`: 5.2:1 (AA合格)
- `#4A4A4A` vs `#E8C4A0`: 5.8:1 (AA合格)

**代替案と却下理由**:
- **黒（#000000）**: コントラストは高いが、木製の雰囲気に合わない
- **成り駒と同じ赤**: 駒の文字と数字の区別が困難

**実装詳細**:
```tsx
const COUNT_COLOR = '#5C4033'; // 濃い茶色
```

### 4. 先手・後手の数字配置

**決定**: 常に画面上の物理的な右下に配置（駒の回転に関係なく）

**理由**:
- 先手・後手で数字の配置が視覚的に統一され、ユーザーが直感的に理解しやすい
- 実装がシンプル（駒の回転を考慮する必要がない）
- 後手の駒は180度回転するが、数字は回転せずに常に右下に固定

**代替案と却下理由**:
- **駒の回転に合わせて配置**: 後手の場合、数字が左上に来るため、視覚的に不自然で、先手との統一感が失われる

**実装詳細**:
```tsx
// 先手・後手共通のスタイル
.piece-count {
  position: absolute;
  right: 2px;
  bottom: 2px;
  // 駒の回転に影響されない
}
```

### 5. 選択状態での数字の可視性

**決定**: z-index とコントラストを調整して可視性を維持

**理由**:
- 選択時のハイライト背景色が変わっても、数字のz-indexを高く設定することで、常に前面に表示
- 必要に応じて、選択時の数字の色を調整（背景とのコントラストを確保）

**実装詳細**:
```css
.piece-count {
  z-index: 10; /* ハイライトより前面 */
}

.selected .piece-count {
  color: #3E2723; /* 選択時はさらに濃い色 */
}
```

### 6. 2桁の数字への対応

**決定**: 右下の配置を維持、フォントサイズは変更しない

**理由**:
- 五角形の駒の右下には、2桁の数字（例: "18"）でも収まる十分なスペースがある
- フォントサイズを縮小すると、判読性が低下する
- 将棋のルール上、同じ種類の駒が18枚を超えることはない（歩が最大18枚）

**実装詳細**:
```tsx
// 数字の桁数に関係なく、同じスタイルを適用
{count !== undefined && count > 1 && (
  <span className="piece-count">{count}</span>
)}
```

## ベストプラクティス

### React + TypeScript

- **型安全性**: count プロパティはオプショナル（`count?: number`）とし、undefined チェックを行う
- **コンポーネント分離**: 数字の表示ロジックは CapturedPieces コンポーネント内に留め、Piece コンポーネントには影響を与えない
- **スタイルの一元管理**: pieceStyle.ts に数字のスタイル定数を追加し、再利用可能にする

### Tailwind CSS

- **カスタムクラス**: 数字の配置に使用する absolute 位置指定は、Tailwind のユーティリティクラスで対応可能
- **動的スタイル**: フォントサイズや色は inline style で動的に設定し、柔軟性を確保

```tsx
<span
  className="absolute right-0.5 bottom-0.5 z-10"
  style={{ fontSize: countFontSize, color: COUNT_COLOR }}
>
  {count}
</span>
```

### アクセシビリティ

- **aria-label**: 数字の意味を明確にするため、駒のボタンの aria-label に枚数を含める
  ```tsx
  aria-label={`持ち駒の${pieceType}${count > 1 ? `（${count}枚）` : ''}`}
  ```
- **コントラスト**: WCAG AA基準を満たす色を使用（上記の色決定を参照）

### パフォーマンス

- **再レンダリング最適化**: count プロパティの変更のみで数字の表示が更新されるため、不要な再レンダリングは発生しない
- **CSS のみ**: 数字の配置はCSS で実現されるため、JavaScript の実行コストは最小限

## 統合パターン

### 既存コンポーネントとの統合

**CapturedPieces.tsx の変更箇所**:

1. **数字の表示ロジックの変更**:
   - 現在: `<span>×{count}</span>` を駒の文字と同じ行に表示
   - 変更後: `<span className="absolute...">` {count}</span>` を駒の右下に配置
   - 「×」記号を削除

2. **スタイルの追加**:
   - 駒のコンテナに `position: relative` を追加（既に設定されている可能性あり）
   - 数字に `position: absolute`、`right`、`bottom`、`z-index` を設定

3. **条件付き表示の維持**:
   - `count > 1` の条件は変更なし（1枚の場合は数字を表示しない）

**影響を受けるコンポーネント**:
- **Piece.tsx**: 影響なし（持ち駒エリアは CapturedPieces コンポーネントで管理）
- **pieceStyle.ts**: 数字のスタイル定数を追加

### テスト戦略

1. **ビジュアルリグレッションテスト**:
   - 数字が駒の右下に正しく配置されているかを確認
   - 2桁の数字も適切に表示されるかを確認

2. **スナップショットテスト**:
   - CapturedPieces コンポーネントの HTML 構造をスナップショット

3. **アクセシビリティテスト**:
   - aria-label に枚数が含まれているかを確認
   - 色のコントラスト比をテスト

4. **エッジケーステスト**:
   - 持ち駒が1枚のみの場合、数字が表示されないことを確認
   - 持ち駒が18枚（最大）の場合、2桁の数字が適切に表示されることを確認
   - 選択状態でも数字が可視であることを確認

## まとめ

この調査により、持ち駒の数字表示位置変更に必要な全ての技術的決定が完了しました。CSS position: absolute を使用したシンプルな実装により、視認性を向上させながら、既存のコンポーネント構造を維持できます。
