# Feature Specification: 駒の捕獲機能

**Feature Branch**: `005-piece-capture`
**Created**: 2025-11-09
**Status**: Draft
**Input**: User description: "相手の駒のいるマス目に自分の駒を移動させたとき、その駒を取れるようにしたい。その逆も同様です。取った駒は持ち駒になるようにする。持ち駒を打つことはまだ作らなくてよい。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 駒の捕獲 (Priority: P1)

プレイヤーが自分の駒を相手の駒が置かれているマス目に移動させたとき、その相手の駒を取ることができる。取られた駒は盤面から除かれ、取ったプレイヤーの持ち駒として記録される。

**Why this priority**: これは将棋の基本ルールの一つであり、ゲームの戦略性を支える中核機能。駒の捕獲がなければ、将棋というゲームが成立しない。

**Independent Test**: 先手と後手の駒を配置し、一方の駒をもう一方の駒のマス目に移動させることで、駒の捕獲と持ち駒への追加を独立して検証できる。

**Acceptance Scenarios**:

1. **Given** 盤面に先手の駒と後手の駒がそれぞれ配置されている、**When** 先手が自分の駒を後手の駒があるマス目に移動させる、**Then** 後手の駒が盤面から取り除かれ、先手の持ち駒として記録される
2. **Given** 盤面に先手の駒と後手の駒がそれぞれ配置されている、**When** 後手が自分の駒を先手の駒があるマス目に移動させる、**Then** 先手の駒が盤面から取り除かれ、後手の持ち駒として記録される
3. **Given** 先手がすでに持ち駒を1つ持っている、**When** 先手がさらに相手の駒を取る、**Then** 取った駒が持ち駒リストに追加され、持ち駒が2つになる
4. **Given** 移動先のマス目に相手の駒がある、**When** プレイヤーがそのマス目に移動を試みる、**Then** 駒の移動が成功し、相手の駒が捕獲される

---

### User Story 2 - 持ち駒の表示 (Priority: P2)

プレイヤーは自分が取った駒（持ち駒）を視覚的に確認できる。持ち駒は盤面外の専用エリアに表示され、種類ごとに整理される。

**Why this priority**: 駒の捕獲機能を実装した後、プレイヤーが自分の持ち駒を確認できることは重要だが、駒を取る機能自体が先に動作する必要がある。

**Independent Test**: 駒を捕獲した後、持ち駒表示エリアに正しい駒の種類と数が表示されることを確認できる。

**Acceptance Scenarios**:

1. **Given** プレイヤーが持ち駒を持っていない、**When** 盤面を表示する、**Then** 持ち駒エリアが空の状態で表示される
2. **Given** 先手が歩を1つ取った、**When** 盤面を表示する、**Then** 先手の持ち駒エリアに歩が1つ表示される
3. **Given** 後手が角と飛車を取った、**When** 盤面を表示する、**Then** 後手の持ち駒エリアに角1つと飛車1つが表示される
4. **Given** 先手が同じ種類の駒を複数取った、**When** 盤面を表示する、**Then** その駒の種類と数量が表示される

---

### Edge Cases

- 持ち駒が同じ種類で複数ある場合、正しくカウントされるか?
- 同一ターン内に複数の駒を取る（二歩などの違反手を除く）場合、すべての駒が正しく持ち駒に追加されるか?
- 王将・玉将を取ろうとした場合の挙動は?（注: 本来は王を取る前にゲーム終了となるべき）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは、プレイヤーが自分の駒を相手の駒が配置されているマス目に移動させたとき、その相手の駒を盤面から取り除かなければならない
- **FR-002**: システムは、取られた駒を、取ったプレイヤーの持ち駒として記録しなければならない
- **FR-003**: システムは、先手と後手それぞれの持ち駒を別々に管理しなければならない
- **FR-004**: システムは、持ち駒を駒の種類ごとに整理して保持しなければならない
- **FR-005**: システムは、同じ種類の持ち駒の数量を正確にカウントしなければならない
- **FR-006**: システムは、各プレイヤーの持ち駒を視覚的に表示しなければならない
- **FR-007**: システムは、駒を取った後もターン制御（手番の交代）を正しく維持しなければならない
- **FR-008**: システムは、空のマス目への移動と相手の駒があるマス目への移動を区別して処理しなければならない
- **FR-009**: システムは、自分の駒があるマス目への移動を禁止しなければならない（既存のルールを維持）

### Key Entities *(include if feature involves data)*

- **持ち駒 (Captured Pieces)**: プレイヤーが取った駒のコレクション。各プレイヤーごとに管理され、駒の種類と数量を含む
- **駒 (Piece)**: 盤面または持ち駒として存在する。種類（歩、香、桂、銀、金、角、飛、王）、所有者（先手/後手）の情報を持つ
- **盤面状態 (Board State)**: 各マス目の駒の配置と、各プレイヤーの持ち駒を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: プレイヤーは相手の駒があるマス目に自分の駒を移動させることで、その駒を取ることができる
- **SC-002**: 取られた駒は100%の確率で取ったプレイヤーの持ち駒として記録される
- **SC-003**: 持ち駒は盤面上で視覚的に確認でき、種類と数量が正確に表示される
- **SC-004**: 駒の捕獲後もターン制御が正しく機能し、手番が適切に交代する
- **SC-005**: プレイヤーは持ち駒の状態を常に確認でき、混乱なくゲームを進行できる
